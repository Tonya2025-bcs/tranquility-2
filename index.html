<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tranquility - Trauma-Informed Reset</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #E8E2D5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 28rem;
            margin: 0 auto;
            min-height: 100vh;
            padding: 1.5rem;
        }
        
        .card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 2px solid #D4AF37;
        }
        
        .button {
            background-color: #2D5016;
            color: white;
            border: none;
            border-radius: 1rem;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(45, 80, 22, 0.3);
            font-size: 1rem;
        }
        
        .button:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
        
        .button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }
        
        .reset-button {
            background-color: white;
            color: #2D5016;
            border: 2px solid #D4AF37;
            border-radius: 1rem;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .reset-button:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
        
        .title {
            color: #2D5016;
            font-size: 2.5rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .timer {
            color: #2D5016;
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .step-text {
            color: #2D5016;
            font-size: 1.25rem;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 0.75rem;
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #D4AF37;
            margin-bottom: 2rem;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #2D5016 0%, #D4AF37 50%, #2D5016 100%);
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .reset-option {
            background-color: white;
            border: 2px solid #D4AF3780;
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            margin-bottom: 1rem;
            display: block;
            font-size: 1rem;
        }
        
        .reset-option:hover {
            transform: scale(1.02);
        }
        
        .reset-option.selected {
            background-color: #2D5016;
            color: white;
            border-color: #D4AF37;
        }
        
        .affirmation {
            background-color: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 0.75rem;
            padding: 1rem;
            color: #2D5016;
            font-style: italic;
            margin-bottom: 1rem;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dots {
            display: flex;
            gap: 0.5rem;
        }
        
        .dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background-color: rgba(74, 103, 65, 0.4);
            transition: all 0.3s ease;
        }
        
        .dot.active {
            background-color: #D4AF37;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.8);
        }
        
        .hidden {
            display: none;
        }
        
        .gradient-line {
            width: 8rem;
            height: 0.25rem;
            margin: 0 auto 0.5rem;
            border-radius: 0.5rem;
            background: linear-gradient(90deg, #D4AF37 0%, #2D5016 50%, #D4AF37 100%);
        }
        
        .step-badge {
            background-color: #2D5016;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .option-title {
            font-weight: bold;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }
        
        .option-desc {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .audio-btn {
            background-color: #4A6741;
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .audio-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
        
        .audio-btn.active {
            background-color: #D4AF37;
            color: #2D5016;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .volume-slider {
            width: 100px;
            height: 5px;
            border-radius: 5px;
            background: #D4AF37;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .volume-slider:hover {
            opacity: 1;
        }
        
        .leaf-logo {
            width: 2.5rem;
            height: 3rem;
            position: absolute;
            top: -2rem;
            right: 1.5rem;
            transform: rotate(25deg);
            animation: gentle-sway 3s ease-in-out infinite;
        }
        
        @keyframes gentle-sway {
            0%, 100% { transform: rotate(25deg) translateY(0px); }
            50% { transform: rotate(30deg) translateY(-2px); }
        }
        
        .title-container {
            position: relative;
            display: inline-block;
        }

        .step-timer-indicator {
            width: 100%;
            height: 3px;
            background-color: rgba(212, 175, 55, 0.3);
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .step-timer-progress {
            height: 100%;
            background-color: #D4AF37;
            transition: width 0.1s linear;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Safety Notice -->
        <div id="safetyNotice" class="card">
            <h3 style="color: #2D5016; font-weight: bold; margin-bottom: 1rem;">
                üõ°Ô∏è Your Safety Comes First
            </h3>
            <p style="color: #2D5016; margin-bottom: 1rem; opacity: 0.8;">
                This is your space. You can pause, skip, or stop at any time. Only engage with what feels safe and comfortable for you.
            </p>
            <button class="button" onclick="hideSafetyNotice()">
                I understand ‚úì
            </button>
        </div>

        <!-- Header -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <div class="title-container">
                <h1 class="title">
                    TRANQUILITY<span style="color: #D4AF37;">‚Ñ¢</span>
                </h1>
                <svg class="leaf-logo" viewBox="0 0 100 140" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 20 C 25 25, 15 45, 20 75 C 25 105, 45 125, 50 130 C 55 125, 75 105, 80 75 C 85 45, 75 25, 50 20 Z" fill="#2D5016"/>
                    <path d="M50 35 L50 115" stroke="#D4AF37" stroke-width="3" stroke-linecap="round"/>
                    <path d="M35 60 Q50 55, 65 60" stroke="#D4AF37" stroke-width="2" stroke-linecap="round" fill="none"/>
                    <path d="M40 80 Q50 75, 60 80" stroke="#D4AF37" stroke-width="2" stroke-linecap="round" fill="none"/>
                </svg>
            </div>
            <div class="gradient-line"></div>
            <p style="color: #2D5016; opacity: 0.7;">
                Soothe the Nervous System, Feel the Calm
            </p>
        </div>

        <!-- Session Complete -->
        <div id="sessionComplete" class="card hidden">
            <div style="text-align: center;">
                <h3 style="color: #2D5016; font-weight: bold; margin-bottom: 1rem;">
                    ‚ú® Session Complete
                </h3>
                <p style="color: #2D5016; margin-bottom: 1rem; opacity: 0.8;">
                    You've taken time to care for yourself. That's something to be proud of.
                </p>
                <button class="button" onclick="resetSession()">
                    Start New Session
                </button>
            </div>
        </div>

        <!-- Audio Controls -->
        <div class="card">
            <h3 style="color: #2D5016; font-weight: bold; text-align: center; margin-bottom: 1rem;">
                üéµ Audio Settings
            </h3>
            <div class="audio-controls">
                <button class="audio-btn" id="voiceBtn" onclick="toggleVoice()">
                    üé§ <span id="voiceText">Your Voice</span>
                </button>
                <button class="audio-btn" id="musicBtn" onclick="toggleMusic()">
                    üéπ <span id="musicText">Piano Music</span>
                </button>
            </div>
            <div class="volume-control" style="justify-content: center;">
                <span style="color: #2D5016; font-size: 0.875rem;">üîä</span>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="50" onchange="updateVolume()">
            </div>
        </div>

        <!-- Reset Type Selection -->
        <div style="margin-bottom: 2rem;">
            <p style="color: #2D5016; font-weight: bold; text-align: center; margin-bottom: 1rem;">
                Choose your reset approach:
            </p>
            
            <button class="reset-option selected" data-type="grounding" onclick="selectReset('grounding')">
                <div class="option-title">üõ°Ô∏è Grounding & Safety</div>
                <div class="option-desc">Find your footing and feel secure in the present moment</div>
            </button>
            
            <button class="reset-option" data-type="soothing" onclick="selectReset('soothing')">
                <div class="option-title">‚ù§Ô∏è Gentle Soothing</div>
                <div class="option-desc">Offer yourself compassion and tender care</div>
            </button>
            
            <button class="reset-option" data-type="activation" onclick="selectReset('activation')">
                <div class="option-title">‚ö° Gentle Activation</div>
                <div class="option-desc">Reconnect with your strength and vitality</div>
            </button>
        </div>

        <!-- Timer -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <div class="timer" id="timer">10:00</div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>

        <!-- Current Step -->
        <div class="card">
            <div style="text-align: center; margin-bottom: 1rem;">
                <span class="step-badge" id="stepBadge">
                    Step 1 of 6
                </span>
            </div>
            
            <!-- Step Auto-Advance Timer -->
            <div class="step-timer-indicator" id="stepTimerIndicator" style="display: none;">
                <div class="step-timer-progress" id="stepTimerProgress"></div>
            </div>
            
            <p class="step-text" id="stepText">
                Notice you are safe in this moment. You have complete control.
            </p>
            
            <!-- Navigation -->
            <div class="navigation">
                <button class="button" id="prevBtn" onclick="prevStep()" disabled>
                    ‚Üê Previous
                </button>
                
                <div class="dots" id="dots">
                    <!-- Dots will be generated by JavaScript -->
                </div>
                
                <button class="button" id="nextBtn" onclick="nextStep()">
                    Next ‚Üí
                </button>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="button" id="playBtn" onclick="togglePlay()">
                ‚ñ∂ Start
            </button>
            <button class="reset-button" onclick="resetSession()">
                ‚Üª Reset
            </button>
        </div>

        <!-- Affirmations -->
        <div class="card">
            <h3 style="color: #2D5016; font-weight: bold; text-align: center; margin-bottom: 1.5rem;">
                üí≠ Gentle Reminders
            </h3>
            <div id="affirmations">
                <!-- Affirmations will be generated by JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; font-size: 0.75rem; color: #2D5016; opacity: 0.6; margin-top: 2rem;">
            <p>This is not a substitute for professional mental health care.</p>
            <p>If you're in crisis, please reach out to a mental health professional.</p>
            <p style="font-weight: bold; margin-top: 1rem;">¬© 2025 Tranquility. All rights reserved.</p>
        </div>
    </div>

    <script>
        // App State
        let isPlaying = false;
        let currentStep = 0;
        let timeLeft = 10 * 60; // 10 minutes
        let selectedReset = 'grounding';
        let timer = null;
        let stepTimer = null;
        let stepProgressTimer = null;
        let stepDuration = 20; // 20 seconds per step
        let stepTimeLeft = 20;
        let voiceEnabled = false;
        let musicEnabled = false;
        let currentAudio = null;
        let backgroundMusic = null;
        let musicAudio = null;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let elevenLabsApiKey = 'sk_7d893139951c8ad466e5c878f2ce5ca3fe53f512b7619d9d';
        let elevenLabsVoiceId = 'K6rt8X9xs4hoCaJoIh1R';

        // Reset Types Data
        const resetTypes = {
            grounding: {
                name: "Grounding & Safety",
                steps: [
                    "Notice you are safe in this moment. You have complete control.",
                    "Feel your feet on the ground. Notice 5 things you can see around you.",
                    "Take a breath only as deep as feels comfortable right now.",
                    "Notice 4 things you can touch. Feel their texture and temperature.",
                    "Allow your nervous system to recognize safety in this space.",
                    "Remember: You can pause or stop anytime. You are in control."
                ]
            },
            soothing: {
                name: "Gentle Soothing",
                steps: [
                    "Place your hands wherever feels most comforting - heart, stomach, or lap.",
                    "Breathe naturally. There's no need to change or fix anything.",
                    "Send yourself compassion for whatever you're experiencing right now.",
                    "Your nervous system is working hard to protect you.",
                    "You are deserving of comfort, care, and gentleness.",
                    "Rest in this moment of self-compassion and acceptance."
                ]
            },
            activation: {
                name: "Gentle Activation",
                steps: [
                    "Gently stretch your arms above your head if it feels right.",
                    "Roll your shoulders slowly backward, releasing any tension.",
                    "Take up space in a way that feels safe and empowering.",
                    "Notice your inherent strength and remarkable resilience.",
                    "Acknowledge: You survived. You are here. You are enough.",
                    "Feel your aliveness, your presence, your unshakeable worth."
                ]
            }
        };

        const affirmations = {
            grounding: [
                "I am safe in this moment",
                "I trust my ability to care for myself",
                "My feelings are valid and important"
            ],
            soothing: [
                "I deserve compassion and kindness",
                "I am worthy of gentleness",
                "I honor my healing journey"
            ],
            activation: [
                "I am resilient and strong",
                "I have survived difficult things before",
                "I choose to honor my experience"
            ]
        };

        // Utility Functions
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimer() {
            document.getElementById('timer').textContent = formatTime(timeLeft);
            const progressPercent = ((10 * 60 - timeLeft) / (10 * 60)) * 100;
            document.getElementById('progress').style.width = progressPercent + '%';
        }

        function updateStepDisplay() {
            const steps = resetTypes[selectedReset].steps;
            document.getElementById('stepText').textContent = steps[currentStep];
            document.getElementById('stepBadge').textContent = `Step ${currentStep + 1} of ${steps.length}`;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentStep === 0;
            document.getElementById('nextBtn').disabled = currentStep === steps.length - 1;
            
            // Update dots
            updateDots();
            
            // Read step aloud if voice is enabled
            if (voiceEnabled && isPlaying) {
                speakText(steps[currentStep]);
            }
            
            // Start auto-advance timer if playing
            if (isPlaying) {
                startStepTimer();
            }
        }

        function updateDots() {
            const dotsContainer = document.getElementById('dots');
            const steps = resetTypes[selectedReset].steps;
            
            dotsContainer.innerHTML = '';
            for (let i = 0; i < steps.length; i++) {
                const dot = document.createElement('div');
                dot.className = `dot ${i === currentStep ? 'active' : ''}`;
                dotsContainer.appendChild(dot);
            }
        }

        function updateAffirmations() {
            const affirmationsContainer = document.getElementById('affirmations');
            const currentAffirmations = affirmations[selectedReset];
            
            affirmationsContainer.innerHTML = '';
            currentAffirmations.forEach(affirmation => {
                const div = document.createElement('div');
                div.className = 'affirmation';
                div.textContent = `üåø ${affirmation}`;
                affirmationsContainer.appendChild(div);
            });
        }

        function startStepTimer() {
            // Clear any existing timers
            stopStepTimer();
            
            // Don't auto-advance on the last step
            const steps = resetTypes[selectedReset].steps;
            if (currentStep >= steps.length - 1) {
                document.getElementById('stepTimerIndicator').style.display = 'none';
                return;
            }
            
            // Show and reset the step timer indicator
            document.getElementById('stepTimerIndicator').style.display = 'block';
            stepTimeLeft = stepDuration;
            document.getElementById('stepTimerProgress').style.width = '0%';
            
            // Update progress bar every 100ms for smooth animation
            stepProgressTimer = setInterval(() => {
                const elapsed = stepDuration - stepTimeLeft;
                const progressPercent = (elapsed / stepDuration) * 100;
                document.getElementById('stepTimerProgress').style.width = progressPercent + '%';
                
                stepTimeLeft -= 0.1;
                
                if (stepTimeLeft <= 0) {
                    nextStep();
                }
            }, 100);
        }

        function stopStepTimer() {
            if (stepProgressTimer) {
                clearInterval(stepProgressTimer);
                stepProgressTimer = null;
            }
            document.getElementById('stepTimerIndicator').style.display = 'none';
        }

        // Audio Functions
        function createBackgroundMusic() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Create calming frequencies
                oscillator1.frequency.setValueAtTime(220, audioContext.currentTime); // A3
                oscillator2.frequency.setValueAtTime(330, audioContext.currentTime); // E4
                
                oscillator1.type = 'sine';
                oscillator2.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                return {
                    start: async () => {
                        try {
                            oscillator1.start();
                            oscillator2.start();
                            return true;
                        } catch (e) {
                            return false;
                        }
                    },
                    stop: () => {
                        try {
                            oscillator1.stop();
                            oscillator2.stop();
                        } catch (e) {}
                    },
                    setVolume: (volume) => {
                        gainNode.gain.setValueAtTime(volume * 0.1, audioContext.currentTime);
                    },
                    pause: () => {},
                    resume: async () => {}
                };
            } catch (e) {
                console.log('Web Audio API not supported');
                return null;
            }
        }

        async function speakTextElevenLabs(text) {
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': elevenLabsApiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: 0.8,
                            similarity_boost: 0.8,
                            style: 0.2,
                            use_speaker_boost: true
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Stop any current audio
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    
                    currentAudio = new Audio(audioUrl);
                    currentAudio.volume = 0.8;
                    await currentAudio.play();
                    
                    // Clean up URL after playing
                    currentAudio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        currentAudio = null;
                    };
                    
                    return true;
                } else {
                    console.log('ElevenLabs API error, falling back to browser speech');
                    return false;
                }
            } catch (error) {
                console.log('ElevenLabs error:', error);
                return false;
            }
        }

        function speakTextBrowser(text) {
            // Stop any current speech
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
            
            if (!voiceEnabled) return;
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = 0.8; // Slower, more calming pace
            currentUtterance.pitch = 0.9; // Slightly lower pitch
            currentUtterance.volume = 0.7; // Gentle volume
            
            // Try to use a female voice for a more soothing experience
            const voices = speechSynthesis.getVoices();
            const femaleVoice = voices.find(voice => 
                voice.name.toLowerCase().includes('female') || 
                voice.name.toLowerCase().includes('woman') ||
                voice.name.toLowerCase().includes('samantha') ||
                voice.name.toLowerCase().includes('karen') ||
                voice.name.toLowerCase().includes('zira')
            );
            
            if (femaleVoice) {
                currentUtterance.voice = femaleVoice;
            }
            
            speechSynthesis.speak(currentUtterance);
        }

        function speakText(text) {
            if (!voiceEnabled) return;
            
            // Try ElevenLabs first, fallback to browser speech
            speakTextElevenLabs(text).then(success => {
                if (!success) {
                    speakTextBrowser(text);
                }
            });
        }

        // Main Functions
        function hideSafetyNotice() {
            document.getElementById('safetyNotice').classList.add('hidden');
        }

        function selectReset(type) {
            selectedReset = type;
            currentStep = 0;
            
            // Update selected button
            document.querySelectorAll('.reset-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            updateStepDisplay();
            updateAffirmations();
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceText = document.getElementById('voiceText');
            
            if (voiceEnabled) {
                voiceBtn.classList.add('active');
                voiceText.textContent = 'Voice On';
                
                // Speak current step if playing
                if (isPlaying) {
                    const steps = resetTypes[selectedReset].steps;
                    speakText(steps[currentStep]);
                }
            } else {
                voiceBtn.classList.remove('active');
                voiceText.textContent = 'Your Voice';
                
                // Stop any current audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                speechSynthesis.cancel();
            }
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const musicBtn = document.getElementById('musicBtn');
            const musicText = document.getElementById('musicText');
            
            if (musicEnabled) {
                musicBtn.classList.add('active');
                musicText.textContent = 'Music On';
                
                if (!backgroundMusic) {
                    backgroundMusic = createBackgroundMusic();
                }
                
                if (backgroundMusic) {
                    backgroundMusic.start().then(success => {
                        if (!success) {
                            musicEnabled = false;
                            musicBtn.classList.remove('active');
                            musicText.textContent = 'Music Failed';
                            setTimeout(() => {
                                musicText.textContent = 'Piano Music';
                            }, 2000);
                        }
                    });
                }
            } else {
                musicBtn.classList.remove('active');
                musicText.textContent = 'Piano Music';
                
                if (backgroundMusic) {
                    backgroundMusic.stop();
                    backgroundMusic = null;
                }
            }
        }

        function updateVolume() {
            const volume = document.getElementById('volumeSlider').value / 100;
            
            if (backgroundMusic && musicEnabled) {
                backgroundMusic.setVolume(volume);
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                playBtn.textContent = '‚è∏ Pause';
                
                // Resume music if it was playing
                if (musicEnabled && backgroundMusic) {
                    backgroundMusic.resume();
                }
                
                // Start voice guidance if enabled
                if (voiceEnabled) {
                    const steps = resetTypes[selectedReset].steps;
                    speakText(steps[currentStep]);
                }
                
                // Start auto-advance timer
                startStepTimer();
                
                timer = setInterval(() => {
                    timeLeft--;
                    updateTimer();
                    
                    if (timeLeft <= 0) {
                        isPlaying = false;
                        playBtn.textContent = '‚ñ∂ Start';
                        clearInterval(timer);
                        stopStepTimer();
                        document.getElementById('sessionComplete').classList.remove('hidden');
                        
                        // Stop audio
                        if (currentAudio) {
                            currentAudio.pause();
                            currentAudio = null;
                        }
                        speechSynthesis.cancel();
                        
                        if (backgroundMusic && musicEnabled) {
                            backgroundMusic.stop();
                            backgroundMusic = null;
                            musicEnabled = false;
                            document.getElementById('musicBtn').classList.remove('active');
                            document.getElementById('musicText').textContent = 'Piano Music';
                        }
                        
                        // Completion message
                        if (voiceEnabled) {
                            speakText("Congratulations! You've completed your reset session. Take a moment to notice how you feel.");
                        }
                    }
                }, 1000);
            } else {
                playBtn.textContent = '‚ñ∂ Start';
                clearInterval(timer);
                stopStepTimer();
                
                // Pause music when session is paused
                if (backgroundMusic && musicEnabled) {
                    backgroundMusic.pause();
                }
                
                // Stop voice
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                speechSynthesis.cancel();
            }
            
            document.getElementById('session